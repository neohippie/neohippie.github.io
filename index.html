<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset=utf-8>
    <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
    
    <title>N E O H I P P I E</title>
    
    <style>
        body { 
            margin          : 0; 
            overflow        : hidden; 
            background-color: #bfd1e5; 
        }
        #canvas { display: none; }
    </style>
</head>

<body>
    <div id="container"><br /><br /><br /><br /><br />L O A D I N G</div>
    <canvas id="canvas"></canvas>

    <script src="js/lib/three.js/three.js">        </script>
    <script src="js/lib/three.js/OrbitControls.js"></script>
    <script src="js/lib/three.js/Mirror.js">       </script>
    <script src="js/lib/three.js/WaterShader.js">  </script>
    <script src="js/lib/three.js/Detector.js">     </script>
    
    <script src="js/loadTextures.js">              </script>
    
    <script>
    
        if (!Detector.webgl) {
            Detector.addGetWebGLMessage();
            document.getElementById('container').innerHTML = "";
        }
        
        var camera, scene, renderer, water;
        
        var worldWidth = 256, worldDepth = 256,
            worldHalfWidth = worldWidth / 2, worldHalfDepth = worldDepth / 2;
            
        var textureAssets = [
            { property: 'waterNormals', file: 'textures/waternormals.jpg' },
            { property: 'heightMap'   , file: 'textures/heightmap.jpg'    }
        ];
            
        loadTextures(textureAssets, function(textures) {
            init(textures);
            animate();
        });
        
        function init(textures) {
        
            var container = document.getElementById('container');
            
            renderer = new THREE.WebGLRenderer();
            renderer.setClearColor( 0xbfd1e5 );
            renderer.setPixelRatio( window.devicePixelRatio );
            renderer.setSize( window.innerWidth, window.innerHeight );
            
            container.innerHTML = "";
            container.appendChild(renderer.domElement);
            
            camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 20000);
            camera.position.set( 2000, 5000, 2000 );
            
            controls = new THREE.OrbitControls( camera, renderer.domElement );
            controls.enablePan = false;
            controls.minDistance = 1000.0;
            controls.maxDistance = 5000.0;
            controls.maxPolarAngle = Math.PI * 0.495;
            controls.target.set( 0, 500, 0 );
            
            scene = new THREE.Scene();
            
            // light
            
            var light = new THREE.DirectionalLight(0xffffbb, 1);
            light.position.set(-1, 1, -1);
            
            scene.add(light);
            scene.add(new THREE.AmbientLight(0x444444));
            
            // water

            var geometry = new THREE.PlaneBufferGeometry(7500, 7500, worldWidth-1, worldDepth-1);
            geometry.rotateX(-Math.PI/2);

            var data     = loadHeight(textures.heightMap.image)
            var vertices = geometry.attributes.position.array;

            for (var i = 0, j = 0, l = vertices.length; i < l; i ++, j += 3) {
                vertices[j+1] = data[i] * 10;
            }            

            textures.waterNormals.wrapS = textures.waterNormals.wrapT = THREE.RepeatWrapping;

            water = new THREE.Water(renderer, camera, scene, {
                textureWidth:  256,
                textureHeight: 256,
                waterNormals: textures.waterNormals,
                alpha: 	1.0,
                sunDirection: light.position.clone().normalize(),
                sunColor:   0xffffff,
                waterColor: 0x001e0f,
                distortionScale: 50.0,
                fog: scene.fog != undefined
            } );

            var mesh = new THREE.Mesh(geometry, water.material);
            mesh.position.set(-5000, -10000, -5000);
            mesh.add(water);
            
            scene.add(mesh);

            window.addEventListener('resize', onWindowResize, false);
        }
        
        function onWindowResize() {
            camera.aspect = window.innerWidth / window.innerHeight;
            camera.updateProjectionMatrix();

            renderer.setSize(window.innerWidth, window.innerHeight);
        }
        
        function loadHeight(img) {
            var canvas  = document.getElementById("canvas");
            var context = canvas.getContext('2d');
            
            canvas.width  = img.width;
            canvas.height = img.height;
            
            context.drawImage(img, 0, 0, img.width, img.height);
            
            var data = context.getImageData(0, 0, img.height, img.width).data;
            var normPixels = []

            for (var i = 0, n = data.length; i < n; i += 4) {
                normPixels.push((data[i] + data[i+1] + data[i+2]) / 3);
            }
            
            return normPixels;
        }
        
        function animate() {
            requestAnimationFrame(animate);
            render();
        }

        function render() {
            water.material.uniforms.time.value += 1.0 / 60.0;
            controls.update();
            water.render();
            renderer.render(scene, camera);
        }
        
    </script>
</body>

</html>
